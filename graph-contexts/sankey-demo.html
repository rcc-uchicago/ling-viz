<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Sankey Diagram</title>
<style>


#chart {
  height: 500px;
}

.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

.link:hover {
  stroke-opacity: .5;
}

</style>
<body>
<p id="chart" />

<script src="d3.js"></script>
<script src="sankey.js"></script>
<script src="graphutils.js"></script>
<script>



function getSankeyData(words, contexts) {
    
    var nodes = [];
    var edges = [];


    var getidx = function(node) {
       for (var i in nodes) {
            var n = nodes[i]; 
            if (node.name == n.name && node.pos == n.pos)
                return +i;
        }
       return -1;
    }


    var nodeadd = function (s, i) { 
        var node = {"name":s, "pos":i};
        if (getidx(node) == -1)
            nodes.push(node);
        return node;
    }
    
    var edgeadd = function (n, m) {
        var src = getidx(n);
        var tar = getidx(m);

        for (var i = 0; i < edges.length; i++) {
            if (edges[i].source == src && edges[i].target == tar) {
                edges[i].value++;
                return;
            }
        }
        var edge = {"source":src, "target":tar, "value":1};
        edges.push(edge);
    }

   for (var i in words) {
     var w = words[i];
     for (var j in contexts[w]) {
        var ctx = contexts[w][j];
        var cs = ctx.split(' ');
        
        /* We either have a start-context, a middle context, or an end context. */
        if (cs[0] == "__") {
            var fst = nodeadd(w, 2);
            var snd = nodeadd(cs[1], 3);
            var thd = nodeadd(cs[2], 4);
        }
        else if (cs[1] == "__") {
            var fst = nodeadd(cs[0], 1);
            var snd = nodeadd(w, 2);
            var thd = nodeadd(cs[2], 3);
        }
        else if (cs[2] == "__") {
            var fst = nodeadd(cs[0], 0);
            var snd = nodeadd(cs[1], 1);
            var thd = nodeadd(w, 2);
        }
        else
            console.log("mayday! bad data.");

        edgeadd(fst, snd);
        edgeadd(snd, thd);
     }
  }


   return {"nodes":nodes, "links":edges};
}


</script>


<script>
/* From SO */
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}


d3.json("json/english-brown.json", function(json) {
    
    /* If using "english-brown.json", try "oh" (fewest contexts) */

    var wordparam = getParameterByName("word");
    var words = wordparam ? wordparam.split(',') : ["oh"];

    var data = getSankeyData(words, json.contexts);


    var margin = {top: 1, right: 1, bottom: 6, left: 1},
        width = document.body.clientWidth - margin.left - margin.right,
        height = 600 - margin.top - margin.bottom;  

    var formatNumber = d3.format(",.0f"),
        format = function(d) { return formatNumber(d) + " TWh"; },
        color = d3.scale.category20();

    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height",height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var sankey = d3.sankey()
        .nodeWidth(15)
        .nodePadding(10)
        .size([width, height]);

    var path = sankey.link();

    sankey
      .nodes(data.nodes)
      .links(data.links)
      .layout(32);

    /* Fix negative heights - ideally, ultimately the Sankey Y-layout should be fixed. */
    for (var p = 0; p < 5; p++) {
        var nd = data.nodes.filter(function (n) { return n.pos == p });
        var ext = d3.extent(nd, function(n) { return n.y; });
        var m = ext[0], M = ext[1];
        if (m < 0 || M > height) {
            var bottom = Math.abs(m);
            var space = bottom + M;
            data.nodes.forEach(function (n) {
                n.y = (n.y + bottom) * (height / space);
            });
        }
    }

  var link = svg.append("g").selectAll(".link")
      .data(data.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });

  link.append("title")
      .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value); });

  var node = svg.append("g").selectAll(".node")
      .data(data.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; }) /* x and y are added by sankey.layout() */
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { this.parentNode.appendChild(this); })
      .on("drag", dragmove));

  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { return d.name + "\n" + format(d.value); });

  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

  function dragmove(d) {
    d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
    sankey.relayout();
    link.attr("d", path);
  }


    /* Fix the height problem in the layout ...
    
    for (var p = 0; p < 5; p++) {
        var nd = d3.selectAll(".node").filter(function(d) { return d.pos == p; });
            nd.each(function(d, i) {
                var r = this.getAttribute("transform"); 
                var ht = r.match(/,(-?[0-9\.]+)\)/);
                if (ht && ht[1] < 0)
                    console.log("oh no in pos " + p);
             });    
    }
    */
   /*
    var nd = d3.selectAll(".node").filter(function (d) { return d.name == "he" });
   var r = nd.attr("transform"); 
   var ht = r.match(/,(-?[0-9\.]+)\)/);
   console.log(ht);
    */

});

</script>
