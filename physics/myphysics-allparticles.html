
<!-- <canvas id="viewport" width="1000px" height="1000px"></canvas> -->

<svg width="1000px" height="1000px" style="border:solid;"></svg>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="physicsjs-full.min.js"></script>
<script>
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

var width= 1000, height = 1000;


var data = n = getParameterByName("number") || 2;
var particles = []
for (var i = 0; i < n; i++) {
	var x = Math.random() * width,
	    y = Math.random() * height;
	var p = {
		pos: {x: x, y: y},
		vel: {x: 0, y:0},
		acc: {x: 0, y:0},
		forces:[],
		radius: 5,
		mass: 10
	}
	particles.push(p);
}

var source = particles[0];
source.isSource = true;
source.pos.x = 500, source.pos.y = 500;
source.mass = +(getParameterByName("sunMass")) || 100;
source.radius = 8;


var circle = d3.select("svg")
    .selectAll(".particle")
  .data(particles).enter()
	.append("circle")
	.attr("class", "particle")
	.attr("cx", function(d) { return d.pos.x})
	.attr("cy", function(d) { return d.pos.y})
	.attr("r", function(d) { return d.radius })
	.attr("fill", "black");




var makeReposition = function(particles, makeForce) {
	
	var f = function() {
		
		
		
		/* update forces */
		particles.forEach(function(p, i) {
			
			p.forces = []
			
			particles.forEach(function(q) {
				if (p == q)
					return;
				p.forces.push(makeForce(p,q));
			})
		
			
		})
		
		/* update positions */
		particles.forEach(function(p) {
			var fx = 0, fy = 0;
			p.forces.forEach(function(f) {
				fx += f.x;
				fy += f.y;
			}); 
		
			// a = F/m = dv/dt. dt = 1. so dv = F/m. //
			var dvx = fx / p.mass,
			dvy = fy / p.mass;
		 
		 	p.vel.x += dvx;
			p.vel.y += dvy;
		 
			p.pos.x += p.vel.x,
			p.pos.y += p.vel.y;
			
			
			/* boundary detection */
			if (p.pos.x > 1000 || p.pos.x < 0) {
				var bdd = (p.pos.x < 0) ? 0 : 1000;
				p.pos.x = bdd;
				p.vel.x = -0.5 * p.vel.x;
			}
			if (p.pos.y > 1000 || p.pos.y < 0) {
				var bdd = (p.pos.y < 0) ? 0 : 1000;
				p.pos.y = bdd;
				p.vel.y = -0.5 * p.vel.y;
			}
			
		})
	    
	}
	
	return f;
}


/* ~Behavior~ Add a gravitation force towards the center.  */

var G = getParameterByName("gravity") || 500;
var exp = getParameterByName("exp") || 2;
function sgn(n) { return (n < 0) ? -1 : 1; } //n/Math.abs(n); }
function makeForce(p, q) {
	var dx = q.pos.x - p.pos.x;
	var dy = q.pos.y - p.pos.y;

	var distsq = (dx*dx) + (dy*dy)
	var distexp = Math.pow(distsq, exp/2)
	var fx = sgn(dx) * G*(p.mass+q.mass)/distexp;
	var fy = sgn(dy) * G*(p.mass+q.mass)/distexp;
	if (fx == NaN || fy == NaN) {
		console.log('error')
		thunk()
	}
	var force  = {"x": fx, "y": fy}
	return force
}
var reposition = makeReposition(particles, makeForce);
var svg = d3.select("svg");
svg.on("click", function() {
d3.timer(function() {
	reposition();
	//render(particles);
	
	circle
		.attr("cx", function(d) { return d.pos.x})
		.attr("cy", function(d) { return d.pos.y}); 
	return 0;
});
});

</script>