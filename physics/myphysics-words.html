<button type="button"  id='stopbutton'>Stop</button> <br>
<canvas id="viewport" width="1000px" height="1000px" style="border:solid;"></canvas>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="physicsjs-full.min.js"></script>
<script>
function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
}

var width= 1000, height = 1000;

d3.json("words.json", function(words) {
	d3.json("sharedcontexts.json", function(matrix) {
		
		var G = getParameterByName("gravity") || 500;
	    var strength = function(p, q) { return G*matrix[p.index][q.index]; }
	
		var particles = []
		words.forEach(function(w, i) {
			if (i > 100)
				return;
		
			var x = Math.random() * width,
			y = Math.random() * height;
		
			var mass = 0;
			for (var j = 0; j < words.length; j++)
				mass += matrix[i][j]
			
			var p = {
				pos: {x: x, y: y},
				vel: {x: 0, y:0},
				acc: {x: 0, y:0},
				forces:[],
				radius: mass/50000,
				mass: mass,
				name: w,
				index: i
			}
			particles.push(p);
		});

		render(particles);
	
		var exp = getParameterByName("exp") || 2;
		function sgn(n) { return (n < 0) ? -1 : 1; }
		function makeForce(p, q) {
			var dx = q.pos.x - p.pos.x;
			var dy = q.pos.y - p.pos.y;

			var distsq = (dx*dx) + (dy*dy)
			var distexp = Math.pow(distsq, exp/2)
			var fx = sgn(dx) * strength(p, q)*(p.mass+q.mass)/distexp;
			var fy = sgn(dy) * strength(p, q)*(p.mass+q.mass)/distexp;
			var force  = {"x": fx, "y": fy}
			return force
		}
		var reposition = makeReposition(particles, makeForce);
	
		var stop = false;
		d3.select("#stopbutton").on("click", function() {
			stop = true;
		});
		d3.select("canvas").on("click", function() {
			stop = false;
			d3.timer(function() {
				reposition();
				render(particles);
	
				return stop;
			});
		});
	
	});
})



var makeReposition = function(particles, makeForce) {
	
	var f = function() {
		
		
		
		/* update forces */
		particles.forEach(function(p, i) {
			
			p.forces = []
			
			particles.forEach(function(q) {
				if (p == q)
					return;
				p.forces.push(makeForce(p,q));
			})
		
			
		})
		
		/* update positions */
		particles.forEach(function(p) {
			var fx = 0, fy = 0;
			p.forces.forEach(function(f) {
				fx += f.x;
				fy += f.y;
			}); 
		
			// a = F/m = dv/dt. dt = 1. so dv = F/m. //
			var dvx = fx / p.mass,
			dvy = fy / p.mass;
		 
		 	p.vel.x += dvx;
			p.vel.y += dvy;
		 
			p.pos.x += p.vel.x,
			p.pos.y += p.vel.y;
			
			
			/* boundary detection */
			if (p.pos.x > 1000 || p.pos.x < 0) {
				var bdd = (p.pos.x < 0) ? 0 : 1000;
				p.pos.x = bdd;
				p.vel.x = -0.5 * p.vel.x;
			}
			if (p.pos.y > 1000 || p.pos.y < 0) {
				var bdd = (p.pos.y < 0) ? 0 : 1000;
				p.pos.y = bdd;
				p.vel.y = -0.5 * p.vel.y;
			}
			
		})
	    
	}
	
	return f;
}

function render(particles) {
    
	var canvas = d3.select("#viewport").node(),
		ctx = canvas.getContext("2d");
		
    ctx.clearRect(0, 0, canvas.width, canvas.height);
	
  	particles.forEach(function(p) {
  		var x = p.pos.x
  		var y = p.pos.y
  		ctx.fillStyle = p.color || "black";
  		ctx.beginPath();
  	    ctx.arc(x, y, p.radius, 0, Math.PI * 2, false);
  	    ctx.fill();
		
  		ctx.fillText(p.name, x+10, y);
  	});
	
}


</script>