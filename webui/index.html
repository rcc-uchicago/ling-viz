<!DOCTYPE html>
<meta charset="utf-8">
<style>

/* unvisited link */
a:link {
    color: grey;
    text-decoration: none;
}

/* visited link */
a:visited {
    color: grey;
    text-decoration: none;
    font: 10px sans-serif;
}

/* selectable table */
table {
    border-collapse: collapse;
}

td {
    border:dotted;
    border-width:1px;
    width:100px;
}
.sel {
    background-color: blue;
    color: white;
}
.unsel {
    background-color: white;
    color: black;
}
.titles {
    font: bold;
}


/* from d3: */
.link {
  stroke: #ccc;
}

.node text {
  pointer-events: all;
  font: 10px sans-serif;
}


</style>
<title>Graph Visualization v 0.1</title>
<body>

<div id="menu" style="width:250px;float:left;">
<input type="file" id="filepicker" accept="application/gexf" title="Pick a file to use" />
<input type="range" id="tickLimit" value="0" min="0" max="100"
       title="How often should Force-Layout update the UI" /> <span id="tickLabel">0</span>
<input type="text" id="nodename" title="Find a node in the graph." /> 
<table id="selected">
<span id="msg" />
</table>
</div>

<div id="content">
<x3d class="x3d" width="800px" height="500px" style="border:solid; border-width:1px;">
</x3d> 

<table id="dtable">
</table>

</div>

<script src="d3.js"></script>
<script src="http://x3dom.org/x3dom/example/x3dom.js"></script>
<script src="d3.layout.force3d.js"></script>
<script src="graphutils.js"></script>
<script>


/* Register Find-Node behavior. */
document.getElementById("nodename").onchange = 
    (function(e) {
        var name = e.target.value;
        /* select the right row in the table - a little hacky. */
        var rows = d3.select("#dtable")
            .select("tbody")
            .selectAll("tr")
            .each(function(r) {
                var cell = this.childNodes[0];
                if (cell.innerHTML == name)
                    d3.select(cell).classed({"sel":true, "unsel":false}); 
                });
        
        findNode(name)
    });

/* Register filepicker handler. */
document.getElementById("filepicker").onchange = handleFileSelect;


/* Uncomment this section for zoom behavior.
/* From: http://stackoverflow.com/questions/7871425/is-there-a-way-to-zoom-into-a-d3-force-layout-graph
var svg = d3.select("svg")
   .attr("pointer-events", "all")
   .call(d3.behavior.zoom().on("zoom", redraw));

var vis = svg
    .append('svg:g')
    .attr("id", "vis")
    .attr("width", svg.attr("width"))
    .attr("height", svg.attr("height"));

function redraw() {
  vis.attr("transform",
      "translate(" + d3.event.translate + ")"
      + " scale(" + d3.event.scale + ")");
}
*/

var x3d = d3.select("x3d");
var vis = x3d
    .append('x3d:scene')
    .attr("id", "vis")
    .attr("width", x3d.attr("width"))
    .attr("height", x3d.attr("height"));


/* Tick slider behavior */
document.getElementById("tickLimit").onchange = function(evt) {
     tickLimit = parseInt(evt.target.value);
     document.getElementById("tickLabel").innerHTML = tickLimit;
}

/* Message box */
function msg(x) {
   d3.select("#msg").html(x);
}
function cls() {
  d3.select("#msg").html(" ");
}

//plotGraph(d3.select("#vis"), [{label:"hi", id:"0", color:"black"}]);
                            //  {label: "bye", id:"1", color:"black"}],
                            //[{source:"0", target:"1"}]);

function getx3d(x3d) {

    var processColor = function(x) {
        var o = x3dom.fields.SFColor.colorParse(x)
        return o.r + " " + o.g + " "  + o.b;
    }

    var node = document.createElement("x3d");
    node.innerHTML = x3d.node().innerHTML;

    var d = d3.select(node)
    d.selectAll("div, canvas, text").remove();
    d.selectAll("material")
        .each(function () {
                var c = this.getAttribute("diffusecolor");
                this.setAttribute("diffusecolor", processColor(c)) });

    var keepattr = ["translation", "diffusecolor", "coordindex", "point", "lit"];
    d.selectAll('*').each(function() {
            var that = this;
            var toRemove = Array.prototype.slice.call(this.attributes)
                .filter(function(a) { return keepattr.indexOf(a.name) < 0; });
            toRemove.forEach(function(a) { that.removeAttribute(a.name); });
    });
           
    var html = node.outerHTML;

    var prefix = '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE X3D PUBLIC "ISO//Web3D//DTD X3D 3.0//EN" "http://www.web3d.org/specifications/x3d-3.0.dtd">\n<X3D xmlns:xsd=\'http://www.w3.org/2001/XMLSchema-instance\' profile=\'Full\' version=\'3.0\' xsd:noNamespaceSchemaLocation=\'http://www.web3d.org/specifications/x3d-3.0.xsd\'>';
    html = html.replace("<x3d>", prefix);


    /* We need to do a TON more replacements because of weird case thing between x3dom/D3/x3d.
       Probably take out of JS. */
    return html.replace(/indexedlineset/g, "IndexedLineSet")
        .replace(/coordindex/g, "coordIndex")
        .replace(/diffusecolor/g, "diffuseColor")
        .replace(/appearance/g, "Appearance")
        .replace(/material/g, "Material")
        .replace(/x3d/g, "X3D")
        .replace(/transform/g, "Transform")
        .replace(/scene/g, "Scene")
        .replace(/coordinate/g, "Coordinate")
        .replace(/shape/g, "Shape")
        .replace(/sphere/g, "Sphere")
}


d3.select("#menu")
    .append("a")
    .attr('download', "graph-image.x3d")
    .text("Download x3d")
    .attr("style", "color:blue;text-decoration:underline;")
    .on("mouseover", function() {
        d3.event.target.href = 'data:text/plain;charset=utf-8,' + getx3d(d3.select("x3d"))       
     });

d3.select("#menu")
    .append("a")
    .attr("href", "#")
    .text("embed")
    .on("click", function() {
        
        var data = getx3d(d3.select("x3d"));
        var x3d = new Blob([data], {type: 'model/x3d+xml;charset=utf-8'});
        var url = window.URL.createObjectURL(x3d);

        var obj = d3.select("#content")
            .append("object")
            .attr("type", "model/x3d+xml")
            .attr("width", "800")
            .attr("height", "500");
        
        obj.node().data = url;

        console.log(url);            
            
            
            
  });

window.setInterval(function() {
    localStorage.setItem("data.x3d", getx3d(d3.select("x3d")));
   }, 2000);



</script>

